(function(){"use strict";try{if(typeof document<"u"){var e=document.createElement("style");e.appendChild(document.createTextNode("body.sy2video-plugin-siyuan>*{visibility:hidden}.sy2video-plugin-siyuan .block__popover .protyle-content{position:fixed;top:50%;left:50%;transform-origin:center center;transform:translate(-50%,-50%) scale(var(--scale-factor));visibility:visible;overflow:visible}")),document.head.appendChild(e)}}catch(i){console.error("vite-plugin-css-injected-by-js",i)}})();
"use strict";var h=Object.defineProperty;var w=(n,e,t)=>e in n?h(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>w(n,typeof e!="symbol"?e+"":e,t);const{fetchSyncPost:y}=require("siyuan");async function u(n,e){let t=await y(n,e);return t.code===0?t.data:null}async function m(n,e){let t=new FormData;t.append("assetsDirPath",n);for(let s of e)t.append("file[]",s);return u("/api/asset/upload",t)}async function f(n,e,t){return u("/api/block/appendBlock",{dataType:n,data:e,parentID:t})}function _(...n){const[e,t]=n.length==2?[n[0],n[1]]:["http://127.0.0.1:9966/tts",n[0]],o=Object.assign({text:"",prompt:"",voice:"11.csv",speed:5,temperature:.3,top_p:.7,top_k:20,refine_max_new_token:384,infer_max_new_token:2048,text_seed:42,skip_refine:0,custom_voice:0},t),s=new FormData;return Object.entries(o).forEach(([a,c])=>{s.append(a,String(c))}),fetch(e,{body:s,method:"POST"}).then(a=>a.json())}const{Plugin:k}=require("siyuan");class b extends k{constructor(){super(...arguments);r(this,"onunloadFn",[])}addUnloadFn(t){this.onunloadFn.push(t)}onunload(){this.onunloadFn.forEach(t=>t())}}const d="sy2video-plugin-siyuan";class g extends b{async onLayoutReady(){var e;{const t=new URLSearchParams(window.location.search),o=t.getAll("block_id");if(t.get("block_show")&&o){this.addFloatLayer({x:0,y:0,ids:[...o]});const a=window.siyuan.blockPanels[0].element;(e=a.querySelector('[data-type="pin"]'))==null||e.click(),setTimeout(()=>{const c=a.querySelector(".protyle-content"),i=window.innerWidth/c.getBoundingClientRect().width,l=window.innerHeight/c.getBoundingClientRect().height,p=l<i?l:i;c.style.setProperty("--scale-factor",String(p))},5e3),document.body.classList.add(d),this.onunloadFn.push(()=>{document.body.classList.remove(d)})}}this.eventBus.on("click-blockicon",t=>{window.siyuan.menus.menu.addItem({label:"转音频",icon:"",click:()=>{const o=t.detail.blockElements[0],s=o.dataset.nodeId,a=o.textContent;this.ttsInsert(s,a)}})})}async ttsInsert(e,t){const o=await _({text:t}),s=await fetch(o.audio_files[0].url).then(c=>c.blob()).then(c=>m("/assets/",[new File([c],`${Date.now()}-${Math.random().toString(36).slice(2)}.${o.audio_files[0].url.split(".").pop()}`)])),a=Object.entries(s.succMap);await Promise.all(a.map(([c,i])=>f("markdown",`<audio controls="controls" src="${i}" data-src="${i}"></audio>`,e)))}}module.exports=g;
//# sourceMappingURL=index.js.map
