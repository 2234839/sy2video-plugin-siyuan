{"version":3,"file":"index.js","sources":["../../src/libs/api.ts","../../src/libs/chat_tts.ts","../../src/sy2video-plugin-siyuan/index.ts"],"sourcesContent":["/**\n * Copyright (c) 2023 frostime. All rights reserved.\n * https://github.com/frostime/sy-plugin-template-vite\n *\n * See API Document in [API.md](https://github.com/siyuan-note/siyuan/blob/master/API.md)\n * API 文档见 [API_zh_CN.md](https://github.com/siyuan-note/siyuan/blob/master/API_zh_CN.md)\n */\n\nimport { fetchSyncPost, IWebSocketData } from \"siyuan\";\n\nasync function request(url: string, data: any) {\n  let response: IWebSocketData = await fetchSyncPost(url, data);\n  let res = response.code === 0 ? response.data : null;\n  return res;\n}\n\n// **************************************** Noteboook ****************************************\n\nexport async function lsNotebooks(): Promise<IReslsNotebooks> {\n  let url = \"/api/notebook/lsNotebooks\";\n  return request(url, \"\");\n}\n\nexport async function openNotebook(notebook: NotebookId) {\n  let url = \"/api/notebook/openNotebook\";\n  return request(url, { notebook: notebook });\n}\n\nexport async function closeNotebook(notebook: NotebookId) {\n  let url = \"/api/notebook/closeNotebook\";\n  return request(url, { notebook: notebook });\n}\n\nexport async function renameNotebook(notebook: NotebookId, name: string) {\n  let url = \"/api/notebook/renameNotebook\";\n  return request(url, { notebook: notebook, name: name });\n}\n\nexport async function createNotebook(name: string): Promise<Notebook> {\n  let url = \"/api/notebook/createNotebook\";\n  return request(url, { name: name });\n}\n\nexport async function removeNotebook(notebook: NotebookId) {\n  let url = \"/api/notebook/removeNotebook\";\n  return request(url, { notebook: notebook });\n}\n\nexport async function getNotebookConf(notebook: NotebookId): Promise<IResGetNotebookConf> {\n  let data = { notebook: notebook };\n  let url = \"/api/notebook/getNotebookConf\";\n  return request(url, data);\n}\n\nexport async function setNotebookConf(\n  notebook: NotebookId,\n  conf: NotebookConf,\n): Promise<NotebookConf> {\n  let data = { notebook: notebook, conf: conf };\n  let url = \"/api/notebook/setNotebookConf\";\n  return request(url, data);\n}\n\n// **************************************** File Tree ****************************************\nexport async function createDocWithMd(\n  notebook: NotebookId,\n  path: string,\n  markdown: string,\n): Promise<DocumentId> {\n  let data = {\n    notebook: notebook,\n    path: path,\n    markdown: markdown,\n  };\n  let url = \"/api/filetree/createDocWithMd\";\n  return request(url, data);\n}\n\nexport async function renameDoc(\n  notebook: NotebookId,\n  path: string,\n  title: string,\n): Promise<DocumentId> {\n  let data = {\n    doc: notebook,\n    path: path,\n    title: title,\n  };\n  let url = \"/api/filetree/renameDoc\";\n  return request(url, data);\n}\n\nexport async function removeDoc(notebook: NotebookId, path: string) {\n  let data = {\n    notebook: notebook,\n    path: path,\n  };\n  let url = \"/api/filetree/removeDoc\";\n  return request(url, data);\n}\n\nexport async function moveDocs(fromPaths: string[], toNotebook: NotebookId, toPath: string) {\n  let data = {\n    fromPaths: fromPaths,\n    toNotebook: toNotebook,\n    toPath: toPath,\n  };\n  let url = \"/api/filetree/moveDocs\";\n  return request(url, data);\n}\n\nexport async function getHPathByPath(notebook: NotebookId, path: string): Promise<string> {\n  let data = {\n    notebook: notebook,\n    path: path,\n  };\n  let url = \"/api/filetree/getHPathByPath\";\n  return request(url, data);\n}\n\nexport async function getHPathByID(id: BlockId): Promise<string> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/filetree/getHPathByID\";\n  return request(url, data);\n}\n\n// **************************************** Asset Files ****************************************\n\nexport async function upload(assetsDirPath: string, files: string | Blob[]): Promise<IResUpload> {\n  let form = new FormData();\n  form.append(\"assetsDirPath\", assetsDirPath);\n  for (let file of files) {\n    form.append(\"file[]\", file);\n  }\n  let url = \"/api/asset/upload\";\n  return request(url, form);\n}\n\n// **************************************** Block ****************************************\ntype DataType = \"markdown\" | \"dom\";\nexport async function insertBlock(\n  dataType: DataType,\n  data: string,\n  nextID?: BlockId,\n  previousID?: BlockId,\n  parentID?: BlockId,\n): Promise<IResdoOperations[]> {\n  let payload = {\n    dataType: dataType,\n    data: data,\n    nextID: nextID,\n    previousID: previousID,\n    parentID: parentID,\n  };\n  let url = \"/api/block/insertBlock\";\n  return request(url, payload);\n}\n\nexport async function prependBlock(\n  dataType: DataType,\n  data: string,\n  parentID: BlockId | DocumentId,\n): Promise<IResdoOperations[]> {\n  let payload = {\n    dataType: dataType,\n    data: data,\n    parentID: parentID,\n  };\n  let url = \"/api/block/prependBlock\";\n  return request(url, payload);\n}\n\nexport async function appendBlock(\n  dataType: DataType,\n  data: string,\n  parentID: BlockId | DocumentId,\n): Promise<IResdoOperations[]> {\n  let payload = {\n    dataType: dataType,\n    data: data,\n    parentID: parentID,\n  };\n  let url = \"/api/block/appendBlock\";\n  return request(url, payload);\n}\n\nexport async function updateBlock(\n  dataType: DataType,\n  data: string,\n  id: BlockId,\n): Promise<IResdoOperations[]> {\n  let payload = {\n    dataType: dataType,\n    data: data,\n    id: id,\n  };\n  let url = \"/api/block/updateBlock\";\n  return request(url, payload);\n}\n\nexport async function deleteBlock(id: BlockId): Promise<IResdoOperations[]> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/block/deleteBlock\";\n  return request(url, data);\n}\n\nexport async function moveBlock(\n  id: BlockId,\n  previousID?: PreviousID,\n  parentID?: ParentID,\n): Promise<IResdoOperations[]> {\n  let data = {\n    id: id,\n    previousID: previousID,\n    parentID: parentID,\n  };\n  let url = \"/api/block/moveBlock\";\n  return request(url, data);\n}\n\nexport async function getBlockKramdown(id: BlockId): Promise<IResGetBlockKramdown> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/block/getBlockKramdown\";\n  return request(url, data);\n}\n\nexport async function getChildBlocks(id: BlockId): Promise<IResGetChildBlock[]> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/block/getChildBlocks\";\n  return request(url, data);\n}\n\nexport async function transferBlockRef(fromID: BlockId, toID: BlockId, refIDs: BlockId[]) {\n  let data = {\n    fromID: fromID,\n    toID: toID,\n    refIDs: refIDs,\n  };\n  let url = \"/api/block/transferBlockRef\";\n  return request(url, data);\n}\n\n// **************************************** Attributes ****************************************\nexport async function setBlockAttrs(id: BlockId, attrs: { [key: string]: string }) {\n  let data = {\n    id: id,\n    attrs: attrs,\n  };\n  let url = \"/api/attr/setBlockAttrs\";\n  return request(url, data);\n}\n\nexport async function getBlockAttrs(id: BlockId): Promise<{ [key: string]: string }> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/attr/getBlockAttrs\";\n  return request(url, data);\n}\n\n// **************************************** SQL ****************************************\n\nexport async function sql(sql: string): Promise<any[]> {\n  let sqldata = {\n    stmt: sql,\n  };\n  let url = \"/api/query/sql\";\n  return request(url, sqldata);\n}\n\nexport async function getBlockByID(blockId: string): Promise<Block> {\n  let sqlScript = `select * from blocks where id ='${blockId}'`;\n  let data = await sql(sqlScript);\n  return data[0];\n}\n\n// **************************************** Template ****************************************\n\nexport async function render(id: DocumentId, path: string): Promise<IResGetTemplates> {\n  let data = {\n    id: id,\n    path: path,\n  };\n  let url = \"/api/template/render\";\n  return request(url, data);\n}\n\nexport async function renderSprig(template: string): Promise<string> {\n  let url = \"/api/template/renderSprig\";\n  return request(url, { template: template });\n}\n\n// **************************************** File ****************************************\n\n/**\n * https://github.com/siyuan-note/siyuan/blob/master/API_zh_CN.md#%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6\n * \"/data/box_id/doc_id.sy\"\n */\nexport async function getFile(path: string): Promise<any> {\n  let data = {\n    path: path,\n  };\n  let url = \"/api/file/getFile\";\n  try {\n    let file = await fetchSyncPost(url, data);\n    return file;\n  } catch (error_msg) {\n    throw error_msg\n    console.log(\"[error_msg]\", error_msg);\n    return null;\n  }\n}\n\nexport async function putFile(path: string, isDir: boolean, file: any) {\n  let form = new FormData();\n  form.append(\"path\", path);\n  form.append(\"isDir\", isDir.toString());\n  // Copyright (c) 2023, terwer.\n  // https://github.com/terwer/siyuan-plugin-importer/blob/v1.4.1/src/api/kernel-api.ts\n  form.append(\"modTime\", Math.floor(Date.now() / 1000).toString());\n  form.append(\"file\", file);\n  let url = \"/api/file/putFile\";\n  return request(url, form);\n}\n\nexport async function removeFile(path: string) {\n  let data = {\n    path: path,\n  };\n  let url = \"/api/file/removeFile\";\n  return request(url, data);\n}\n\nexport async function readDir(path: string): Promise<IResReadDir> {\n  let data = {\n    path: path,\n  };\n  let url = \"/api/file/readDir\";\n  return request(url, data);\n}\n\n// **************************************** Export ****************************************\n\nexport async function exportMdContent(id: DocumentId): Promise<IResExportMdContent> {\n  let data = {\n    id: id,\n  };\n  let url = \"/api/export/exportMdContent\";\n  return request(url, data);\n}\n\nexport async function exportResources(paths: string[], name: string): Promise<IResExportResources> {\n  let data = {\n    paths: paths,\n    name: name,\n  };\n  let url = \"/api/export/exportResources\";\n  return request(url, data);\n}\n\n// **************************************** Convert ****************************************\n\nexport type PandocArgs = string;\nexport async function pandoc(args: PandocArgs[]) {\n  let data = {\n    args: args,\n  };\n  let url = \"/api/convert/pandoc\";\n  return request(url, data);\n}\n\n// **************************************** Notification ****************************************\n\n// /api/notification/pushMsg\n// {\n//     \"msg\": \"test\",\n//     \"timeout\": 7000\n//   }\nexport async function pushMsg(msg: string, timeout: number = 7000) {\n  let payload = {\n    msg: msg,\n    timeout: timeout,\n  };\n  let url = \"/api/notification/pushMsg\";\n  return request(url, payload);\n}\n\nexport async function pushErrMsg(msg: string, timeout: number = 7000) {\n  let payload = {\n    msg: msg,\n    timeout: timeout,\n  };\n  let url = \"/api/notification/pushErrMsg\";\n  return request(url, payload);\n}\n\n// **************************************** Network ****************************************\nexport async function forwardProxy(\n  url: string,\n  method: string = \"GET\",\n  payload: any = {},\n  headers: any[] = [],\n  timeout: number = 7000,\n  contentType: string = \"text/html\",\n): Promise<IResForwardProxy> {\n  let data = {\n    url: url,\n    method: method,\n    timeout: timeout,\n    contentType: contentType,\n    headers: headers,\n    payload: payload,\n  };\n  let url1 = \"/api/network/forwardProxy\";\n  return request(url1, data);\n}\n\n// **************************************** System ****************************************\n\nexport async function bootProgress(): Promise<IResBootProgress> {\n  return request(\"/api/system/bootProgress\", {});\n}\n\nexport async function version(): Promise<string> {\n  return request(\"/api/system/version\", {});\n}\n\nexport async function currentTime(): Promise<number> {\n  return request(\"/api/system/currentTime\", {});\n}\n\nexport async function insertLocalAssets(data: {\n  assetPaths: string[];\n  isUpload: boolean;\n  id: string;\n}): Promise<{\n  succMap: {\n    [assetFileName: string]: string;\n  };\n}> {\n  return request(\"/api/asset/insertLocalAssets\", data);\n}\n","\r\ntype data = {\r\n  prompt: string;\r\n  voice: number;\r\n  speed: number;\r\n  temperature: number;\r\n  top_p: number;\r\n  top_k: number;\r\n  refine_max_new_token: number;\r\n  infer_max_new_token: number;\r\n  text_seed: number;\r\n  skip_refine: number;\r\n  custom_voice: number;\r\n};\r\ntype par = Partial<data> & { text: string };\r\ntype chatTTS_res = {\r\n  audio_files: {\r\n    audio_duration: number;\r\n    filename: string;\r\n    inference_time: number;\r\n    url: string;\r\n  }[];\r\n  code: number;\r\n  filename: string;\r\n  msg: string;\r\n  url: string;\r\n};\r\n/** 默认 apiURL = http://127.0.0.1:9966/tts */\r\nexport function chatTTS(data: par): Promise<chatTTS_res>;\r\nexport function chatTTS(apiURL: string, data: par): Promise<chatTTS_res>;\r\nexport function chatTTS(...arg: [par] | [string, par]): Promise<chatTTS_res> {\r\n  const [apiURL, data] = arg.length == 2 ? [arg[0], arg[1]] : [\"http://127.0.0.1:9966/tts\", arg[0]];\r\n\r\n  const par = Object.assign(\r\n    {\r\n      text: \"\",\r\n      prompt: \"\",\r\n      voice: 2222,\r\n      speed: 4,\r\n      temperature: 0.3,\r\n      top_p: 0.7,\r\n      top_k: 20,\r\n      refine_max_new_token: 384,\r\n      infer_max_new_token: 2048,\r\n      text_seed: 42,\r\n      skip_refine: 1,\r\n      custom_voice: 324256,\r\n    },\r\n    data,\r\n  );\r\n  const from = new FormData();\r\n  Object.entries(par).forEach(([key, value]) => {\r\n    from.append(key, String(value));\r\n  });\r\n  return fetch(apiURL, {\r\n    body: from,\r\n    method: \"POST\",\r\n  }).then((r) => r.json());\r\n}\r\n","import { Plugin } from \"siyuan\";\r\nimport { appendBlock, upload } from \"~/libs/api\";\r\nimport { chatTTS } from \"~/libs/chat_tts\";\r\nimport \"./view_block.css\";\r\n// 引入这个变量后 vite 会自动注入 hot\r\nimport.meta.hot;\r\n\r\nconst classFlag = `sy2video-plugin-siyuan`;\r\n\r\nexport default class sy2video extends Plugin {\r\n  async onLayoutReady() {\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const blockId = urlParams.getAll(\"block_id\");\r\n    const block_show = urlParams.get(\"block_show\");\r\n    if (block_show && blockId) {\r\n      this.addFloatLayer({\r\n        x: 0,\r\n        y: 0,\r\n        ids: [...blockId],\r\n      });\r\n      const el: HTMLElement = window.siyuan.blockPanels[0].element;\r\n      //   钉住\r\n      (el.querySelector(`[data-type=\"pin\"]`) as HTMLButtonElement)?.click();\r\n      // protyle-content\r\n      // (el.querySelector(`[data-type=\"pin\"]`)\r\n      setTimeout(() => {\r\n        const contentEL = el.querySelector<HTMLElement>(`.protyle-content`)!;\r\n        const rate = window.innerHeight / contentEL.getBoundingClientRect().height;\r\n        console.log(\"[rate]\", rate);\r\n        contentEL.style.setProperty(\"--scale-factor\", String(rate));\r\n      }, 1000);\r\n      document.body.classList.add(classFlag);\r\n      this.onunloadFn.push(() => {\r\n        document.body.classList.remove(classFlag);\r\n      });\r\n    }\r\n\r\n    this.eventBus.on(\"click-blockicon\", (event) => {\r\n      window.siyuan.menus.menu.addItem({\r\n        label: \"转音频\",\r\n        icon: ``,\r\n        click: () => {\r\n          const el = event.detail.blockElements[0];\r\n          const id = el.dataset.nodeId!;\r\n          const text = el.textContent!;\r\n          this.ttsInsert(id, text);\r\n        },\r\n      });\r\n    });\r\n  }\r\n  async ttsInsert(id: string, text: string) {\r\n    const res = await chatTTS({\r\n      text,\r\n    });\r\n    const res2 = await fetch(res.audio_files[0].url)\r\n      .then((response) => response.blob())\r\n      .then((blob) => {\r\n        return upload(\"/assets/\", [\r\n          new File(\r\n            [blob],\r\n            `${Date.now()}-${Math.random().toString(36).slice(2)}.${res.audio_files[0].url\r\n              .split(\".\")\r\n              .pop()!}`,\r\n          ),\r\n        ]);\r\n      });\r\n    const assets = Object.entries(res2.succMap);\r\n    await Promise.all(\r\n      assets.map(([_, assertName]) => {\r\n        return appendBlock(\r\n          \"markdown\",\r\n          `<audio controls=\"controls\" src=\"${assertName}\" data-src=\"${assertName}\"></audio>`,\r\n          id,\r\n        );\r\n      }),\r\n    );\r\n  }\r\n  onunloadFn: (() => void)[] = [];\r\n  onunload(): void {\r\n    this.onunloadFn.forEach((fn) => fn());\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}